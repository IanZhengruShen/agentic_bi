name: Trunk CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Fast checks that fail quickly
  pre-checks:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check commit messages
        run: |
          # Ensure commits follow conventional commits (optional)
          echo "Checking commit message format..."

      - name: Check for merge conflicts markers
        run: |
          if git grep -n "<<<<<<< HEAD" -- '*.py' '*.js' '*.ts' '*.java' '*.go' '*.rs' 2>/dev/null; then
            echo "Found merge conflict markers!"
            exit 1
          fi

  # Example: Add your language-specific jobs here
  # Uncomment and modify based on your stack

  # build-python:
  #   name: Build & Test (Python)
  #   runs-on: ubuntu-latest
  #   needs: pre-checks
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.11'
  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -r requirements.txt
  #     - name: Lint
  #       run: |
  #         pip install ruff
  #         ruff check .
  #     - name: Type check
  #       run: |
  #         pip install mypy
  #         mypy .
  #     - name: Run tests
  #       run: pytest --cov=. --cov-report=xml
  #     - name: Upload coverage
  #       uses: codecov/codecov-action@v3

  # build-node:
  #   name: Build & Test (Node.js)
  #   runs-on: ubuntu-latest
  #   needs: pre-checks
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'
  #     - run: npm ci
  #     - run: npm run lint
  #     - run: npm run type-check
  #     - run: npm test -- --coverage
  #     - run: npm run build

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: pre-checks
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Integration tests (if applicable)
  # integration-tests:
  #   name: Integration Tests
  #   runs-on: ubuntu-latest
  #   needs: [build-python, build-node]
  #   services:
  #     postgres:
  #       image: postgres:15
  #       env:
  #         POSTGRES_PASSWORD: postgres
  #       options: >-
  #         --health-cmd pg_isready
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Run integration tests
  #       run: npm run test:integration

  # Trunk-based development specific checks
  trunk-checks:
    name: Trunk Development Checks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check branch age
        run: |
          # Warn if branch is more than 3 days old
          BRANCH_DATE=$(git log --format=%ct origin/${{ github.head_ref }} | tail -1)
          CURRENT_DATE=$(date +%s)
          DAYS_OLD=$(( ($CURRENT_DATE - $BRANCH_DATE) / 86400 ))

          echo "Branch is $DAYS_OLD days old"

          if [ $DAYS_OLD -gt 3 ]; then
            echo "⚠️  Warning: This branch is more than 3 days old."
            echo "Consider breaking it into smaller PRs for trunk-based development."
          fi

      - name: Check PR size
        run: |
          # Warn on large PRs
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          LINES_CHANGED=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oE '[0-9]+ insertion|[0-9]+ deletion' | grep -oE '[0-9]+' | awk '{s+=$1} END {print s}')

          echo "Files changed: $FILES_CHANGED"
          echo "Lines changed: $LINES_CHANGED"

          if [ $FILES_CHANGED -gt 20 ] || [ ${LINES_CHANGED:-0} -gt 500 ]; then
            echo "⚠️  Warning: Large PR detected."
            echo "Consider breaking this into smaller, more focused changes."
          fi

  # All checks must pass
  all-checks-pass:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [pre-checks, security-scan, trunk-checks]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ contains(needs.*.result, 'failure') }}" == "true" ]; then
            echo "One or more checks failed"
            exit 1
          fi
          echo "All checks passed! ✓"
